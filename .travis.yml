language: python

python:
    - 2.7
    - 3.5

env:
    global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
       - secure: "Qw4OhHWDjXP/dTw91vSkt49J9uOurG4KKyWeAFqSqy6qd9xXY1fK7YoMxOMoe4ADmm9CdpyPM6ISRBH9u7uqn7O/WWtOtDLZq3dibuOLYHNCcHgN5kTOS8aIRY+e8jwEd42Ju2ETx2BvSTvgyop7vYiKlazLuKpVX7SQaFe/iKY0twLeHLJlIgilf83kCs0OaKEZbagYfuJcJHm4ouS/RCvL6biGinYoGafJ632c3vDudDNfOtntLDFamg3MuiZo2XX0BhLJn0fTYXcnW94kAhgB1poKsyqkc3LUrpFt1Tk42POK1pD60/F1XcgaCu8MDYlPJ7K8fxuZ54Uaun7rcv/ymNGyXw+s7lZhaHQ/GqK/oekmZj3q4gJPCMkpib6DL3Qn0iUIIhmHnhha4YYk2MsKRRkF6XcuxXXIJFK4wij/FKGhpWUfmAl8M8ljqj8/Qpdi4QbDltGNbjb0DSYdrENGAo2QhaggddW4pmclvt6eBU8y3OGVhwdMwJuOKTpCg01nmPpfYdLZyJcuRJVe2gTQFbB5wrWR0I4mQmewCKHPsfkQRQOTiydbNqm7H8dGTUczvrRwpemmy5bgg5a8ONJ6a7aGcAH3JLhr9/l4K8fKMz11jKLPebMG5/gdWm6mBpHl3m5BLIBNFegxlleh45JVBdfeMy5TjCikwObDuIo="
    matrix:
        - NUMPY_VERSION=1.11.1


before_install:
    - test $TRAVIS_BRANCH != coverity_scan -o ${TRAVIS_JOB_NUMBER##*.} = 1 || exit 0
    - wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh
    - chmod +x miniconda.sh
    - ./miniconda.sh -b -p $HOME/miniconda
    - export PATH=$HOME/miniconda/bin:$PATH
    - conda update --yes conda

install:
    - conda create --yes -n test python=$TRAVIS_PYTHON_VERSION
    - source activate test
    - conda install --yes numpy=$NUMPY_VERSION nose cython mpi4py
    - python setup.py install

script:
    - test $TRAVIS_BRANCH != coverity_scan || exit 0
    - echo "Testing CMAKE build"
    - mkdir build; (cd build; cmake -DCMAKE_INSTALL_PREFIX:PATH=install .. ; make install )
    - echo "Testing Python binding"
    - pip install mpi4py_test
    - python ./runtests.py --mpirun
    - bash check_tag.sh bigfile/version.py

deploy:
    - provider: pypi
      distributions: sdist
      server: https://pypi.python.org/pypi
      user: "rainwoodman"
      password:
          secure: "l2vPJwmSojLOjHOQag7lY6kZJJLaosxqGFVmmuCuxTQEoxmnNlQAOPo/yC1rlgxxc3YHnMwPHfFSbhHBPrXfKpqUBhWDV26Fc8aj/uY1+jGxvQ9UEWu78D1CxqqwS6k90d9dR4QClrBwpuOVNqpsdqoq4u0TgHd0QxywJUq/ZnhWtYEq2wSVv2w4YIlWNLBn38Yr1KmaCC9F0sbLyqUoqRQcnSGSqabvATx3cqT04EYEMmjkUo5HtIjUlOzEKt+Ek6ycQfAFrFwX5X5gRBdouBKBpMfiK0VsHwmJczmxQlgspBJehU6us4SB7XNVS5jDNPGB/kqLFjMZICFf1xzG8VVg0gEnynYDuJUaKtI96NxgQy049bK1CHkogK/UGmzcITO/0GMkzli/s1jIxN1J67cqJ5GI5oXf1hmVRKUaTz9Jhvm0jl4QqLRD3JFf03qcMA2LfOVenEM72H9+Q1CvamfYNkDqZHAJYiCCbVjBybHfi0Nsr52eqgS9W6tJ10avUyXiLWfYZHwZYgaLq0jtpqFim3UKQDXKiYvpKuOaN7POxo3hwllt3ONJEVDJNOMyG2EGTzrPrzzxi5zj0350k0QDS9X629H/XCYfX+5ohH5cPeZjVWvE/Q893bwSCqkDOTXBDpSeZDKtXN3FHDyQAw4hRrIgSsbXyX9GAlj+vPA="
      on:
        tags   : true
        condition : ${TRAVIS_JOB_NUMBER##*.} == 1
addons:
  coverity_scan:
    project:
      name: "rainwoodman/bigfile"
      description: "Build submitted via Travis CI"
    notification_email: rainwoodman@gmail.com
#    build_command_prepend: "./configure; make clean"
    build_command:   "cd src; make"
    branch_pattern: coverity_scan
